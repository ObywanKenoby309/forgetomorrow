generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Job {
  id                Int           @id @default(autoincrement())
  company           String
  title             String
  worksite          String
  location          String
  type              String?
  compensation      String?
  description       String
  status            String        @default("Draft")
  urgent            Boolean       @default(false)
  viewsCount        Int           @default(0)
  applicationsCount Int           @default(0)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  userId            String
  accountKey        String?
  applications      Application[]
  covers            Cover[]
  interviews        Interview[]
  views             JobView[]
  user              User          @relation(fields: [userId], references: [id])
  offers            Offer[]
  pinnedBy          PinnedJob[]

  @@index([accountKey])
  @@map("jobs")
}

model Application {
  id        Int      @id @default(autoincrement())
  userId    String
  jobId     Int
  resumeId  Int?
  coverId   Int?
  status    String   @default("Applied")
  appliedAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  job       Job      @relation(fields: [jobId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("applications")
}

model JobView {
  id       Int      @id @default(autoincrement())
  userId   String
  jobId    Int
  viewedBy String?
  viewedAt DateTime @default(now())
  job      Job      @relation(fields: [jobId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@map("job_views")
}

model Interview {
  id          Int      @id @default(autoincrement())
  userId      String
  jobId       Int
  scheduledAt DateTime
  status      String   @default("Scheduled")
  job         Job      @relation(fields: [jobId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@map("interviews")
}

model Offer {
  id         Int      @id @default(autoincrement())
  userId     String
  jobId      Int
  salary     String?
  accepted   Boolean?
  receivedAt DateTime @default(now())
  job        Job      @relation(fields: [jobId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@map("offers")
}

model PinnedJob {
  id       Int      @id @default(autoincrement())
  userId   String
  jobId    Int
  pinnedAt DateTime @default(now())
  job      Job      @relation(fields: [jobId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@map("pinned_jobs")
}

model ExternalJob {
  id          String    @id @default(cuid())
  title       String?
  company     String?   @default("Not Provided")
  location    String?   @default("Not Provided")
  url         String?   @default("Not Provided")
  description String?
  salary      String?
  tags        String?
  publishedAt DateTime? @default(now())
  source      String
  createdAt   DateTime? @default(now())
  updatedAt   DateTime? @updatedAt

  @@index([source])
  @@map("external_jobs")
}

model Resume {
  id        Int      @id @default(autoincrement())
  userId    String
  name      String
  content   String
  isPublic  Boolean  @default(false)
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("resumes")
}

model Cover {
  id        Int      @id @default(autoincrement())
  userId    String
  jobId     Int?
  name      String
  content   String
  isPublic  Boolean  @default(false)
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  job       Job?     @relation(fields: [jobId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([jobId])
  @@map("covers")
}

model ScanLog {
  id        String   @id @default(cuid())
  userId    String
  date      String
  score     Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@map("scan_logs")
}

model VerificationToken {
  id           Int      @id @default(autoincrement())
  token        String   @unique
  email        String
  firstName    String
  lastName     String
  passwordHash String
  plan         String?
  newsletter   Boolean  @default(false)
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@map("verification_tokens")
}

model CareerRoadmap {
  id          String   @id @default(cuid())
  userId      String
  generatedAt DateTime @default(now())
  data        Json
  pdfUrl      String?
  isPro       Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation("UserCareerRoadmaps", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Negotiation {
  id        String   @id @default(cuid())
  userId    String
  input     Json
  result    Json
  pdfUrl    String?
  createdAt DateTime @default(now())
  user      User     @relation("UserNegotiations", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ProfileSnapshot {
  id        String   @id @default(cuid())
  userId    String
  headline  String?
  bio       String?
  skills    String
  resumeId  String?
  createdAt DateTime @default(now())
  user      User     @relation("UserProfileSnapshots", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserConsent {
  id          Int      @id @default(autoincrement())
  userId      String
  consentType String
  region      String?
  given       Boolean  @default(true)
  timestamp   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, consentType])
  @@map("user_consents")
}

model User {
  id                         String                         @id @default(cuid())
  email                      String                         @unique
  aboutMe                    String?
  accountKey                 String?
  avatarUrl                  String?
  bannerFocalY               Int?
  bannerHeight               Int?
  bannerMode                 String?
  corporateBannerKey         String?
  corporateBannerLocked      Boolean                        @default(false)
  coverUrl                   String?
  createdAt                  DateTime                       @default(now())
  deletedAt                  DateTime?
  emailVerificationExpiresAt DateTime?
  emailVerificationToken     String?                        @unique
  emailVerified              Boolean                        @default(false)
  firstName                  String?
  headline                   String?
  hobbiesJson                Json?
  image                      String?
  isProfilePublic            Boolean                        @default(false)
  languagesJson              Json?
  lastName                   String?
  location                   String?
  mfaEnabled                 Boolean                        @default(false)
  mfaSecret                  String?
  name                       String?
  newsletter                 Boolean                        @default(false)
  passwordHash               String?
  plan                       Tier                           @default(FREE)
  pronouns                   String?
  skillsJson                 Json?
  slug                       String?                        @unique
  slugChangeCount            Int                            @default(0)
  slugLastChangedAt          DateTime?
  status                     String?
  stripeCustomerId           String?                        @unique
  stripeSubscriptionId       String?                        @unique
  updatedAt                  DateTime                       @updatedAt
  wallpaperUrl               String?
  workPreferences            Json?
  role                       UserRole                       @default(SEEKER)
  careerRoadmaps             CareerRoadmap[]                @relation("UserCareerRoadmaps")
  negotiations               Negotiation[]                  @relation("UserNegotiations")
  profileSnapshots           ProfileSnapshot[]              @relation("UserProfileSnapshots")
  applications               Application[]
  candidates                 Candidate[]
  conversationParticipants   ConversationParticipant[]      @relation("UserConversationParticipants")
  covers                     Cover[]
  interviews                 Interview[]
  views                      JobView[]
  jobs                       Job[]
  messages                   Message[]                      @relation("UserMessages")
  offers                     Offer[]
  pinnedJobs                 PinnedJob[]
  candidateAutomations       RecruiterCandidateAutomation[]
  resumes                    Resume[]
  scanLogs                   ScanLog[]
  blocksReceived             UserBlock[]                    @relation("UserBlocksAsBlocked")
  blocksInitiated            UserBlock[]                    @relation("UserBlocksAsBlocker")
  consents                   UserConsent[]

  @@map("users")
}

model Candidate {
  id                Int       @id @default(autoincrement())
  userId            String
  name              String
  email             String?
  headline          String?
  summary           String?
  location          String?
  role              String?
  title             String?
  currentTitle      String?
  workStatus        String?
  preferredWorkType String?
  willingToRelocate String?
  skills            String?
  languages         String?
  tags              String?
  notes             String?
  source            String?
  pipelineStage     String?
  match             Int?
  lastContacted     DateTime?
  lastSeen          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("candidates")
}

model RecruiterCandidateAutomation {
  id        String    @id @default(cuid())
  userId    String
  name      String?
  filters   Json
  enabled   Boolean   @default(true)
  lastRunAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("recruiter_candidate_automation")
}

model Conversation {
  id           Int                       @id @default(autoincrement())
  isGroup      Boolean                   @default(false)
  title        String?
  channel      String?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id             Int          @id @default(autoincrement())
  conversationId Int
  userId         String
  joinedAt       DateTime     @default(now())
  role           String?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation("UserConversationParticipants", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int
  senderId       String
  content        String
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("UserMessages", fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

model UserBlock {
  id        Int      @id @default(autoincrement())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())
  blocked   User     @relation("UserBlocksAsBlocked", fields: [blockedId], references: [id], onDelete: Cascade)
  blocker   User     @relation("UserBlocksAsBlocker", fields: [blockerId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("user_blocks")
}

model FeedPost {
  id         Int      @id @default(autoincrement())
  authorId   String
  authorName String
  content    String
  type       String   @default("business")
  likes      Int      @default(0)
  comments   Json     @default("[]")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([authorId])
  @@map("feed_posts")
}

model SupportTicket {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userId         String?
  userEmail      String?
  subject        String
  initialMessage String
  source         String
  personaId      String?
  intent         String?
  status         String
}

enum UserRole {
  SEEKER
  COACH
  RECRUITER
  ADMIN
}

enum Tier {
  FREE
  PRO
  COACH
  SMALL_BIZ
  ENTERPRISE
}
