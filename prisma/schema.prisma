// ============================================================================
//  PRISMA CONFIGURATION
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
//  ENUMS
// ============================================================================

enum UserRole {
  SEEKER
  COACH
  RECRUITER
  ADMIN
}

enum Tier {
  FREE
  PRO
  COACH
  SMALL_BIZ
  ENTERPRISE
}

enum ContactRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELED
}

// ============================================================================
//  JOBS, APPLICATIONS, INTERVIEWS & OFFERS
// ============================================================================

model Job {
  id                Int      @id @default(autoincrement())
  company           String
  title             String
  worksite          String
  location          String
  type              String?
  compensation      String?
  description       String
  status            String   @default("Draft")
  urgent            Boolean  @default(false)
  viewsCount        Int      @default(0)
  applicationsCount Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Owner
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // ðŸ”¸ which account / org owns this job (for tracing & reporting)
  accountKey String? // e.g. "ACCT-12345" or internal org code

  applications Application[]
  views        JobView[]
  interviews   Interview[]
  offers       Offer[]
  pinnedBy     PinnedJob[]
  covers       Cover[]

  @@index([accountKey])
  @@map("jobs")
}

model Application {
  id        Int      @id @default(autoincrement())
  userId    String
  jobId     Int
  resumeId  Int?
  coverId   Int?
  status    String   @default("Applied")
  appliedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  job  Job  @relation(fields: [jobId], references: [id])

  @@map("applications")
}

model JobView {
  id       Int      @id @default(autoincrement())
  userId   String
  jobId    Int
  viewedBy String?
  viewedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  job  Job  @relation(fields: [jobId], references: [id])

  @@map("job_views")
}

model Interview {
  id          Int      @id @default(autoincrement())
  userId      String
  jobId       Int
  scheduledAt DateTime
  status      String   @default("Scheduled")

  user User @relation(fields: [userId], references: [id])
  job  Job  @relation(fields: [jobId], references: [id])

  @@map("interviews")
}

model Offer {
  id         Int      @id @default(autoincrement())
  userId     String
  jobId      Int
  salary     String?
  accepted   Boolean?
  receivedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  job  Job  @relation(fields: [jobId], references: [id])

  @@map("offers")
}

model PinnedJob {
  id       Int      @id @default(autoincrement())
  userId   String
  jobId    Int
  pinnedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  job  Job  @relation(fields: [jobId], references: [id])

  @@map("pinned_jobs")
}

// ============================================================================
//  EXTERNAL / INGESTED JOB FEED (for cron imports)
// ============================================================================

model ExternalJob {
  id          String    @id @default(cuid())
  title       String?
  company     String?   @default("Not Provided")
  location    String?   @default("Not Provided")
  url         String?   @default("Not Provided")
  description String?
  salary      String?
  tags        String?
  publishedAt DateTime? @default(now())
  source      String
  createdAt   DateTime? @default(now())
  updatedAt   DateTime? @updatedAt

  @@index([source])
  @@map("external_jobs")
}

// ============================================================================
//  RESUMES, COVERS, AND SCAN LOGS
// ============================================================================

model Resume {
  id        Int      @id @default(autoincrement())
  userId    String
  name      String // e.g. "Primary CS Resume"
  content   String // JSON/string from builder
  isPublic  Boolean  @default(false) // future: shareable public link
  isPrimary Boolean  @default(false) // only one per user should be true
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("resumes")
}

model Cover {
  id        Int      @id @default(autoincrement())
  userId    String
  jobId     Int?
  name      String // e.g. "General Cover", "CS Lead Cover"
  content   String
  isPublic  Boolean  @default(false) // for future public sharing if needed
  isPrimary Boolean  @default(false) // only one per user should be true
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  job  Job? @relation(fields: [jobId], references: [id])

  @@index([userId])
  @@index([jobId])
  @@map("covers")
}

model ScanLog {
  id        String   @id @default(cuid())
  userId    String
  date      String
  score     Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@map("scan_logs")
}

// ============================================================================
//  VERIFICATION / AUTH
// ============================================================================

model VerificationToken {
  id           Int      @id @default(autoincrement())
  token        String   @unique
  email        String
  firstName    String
  lastName     String
  passwordHash String
  plan         String?
  newsletter   Boolean  @default(false)
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@map("verification_tokens")
}

// ============================================================================
//  CAREER TOOLS & HISTORY
// ============================================================================

model CareerRoadmap {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("UserCareerRoadmaps", fields: [userId], references: [id], onDelete: Cascade)
  generatedAt DateTime @default(now())
  data        Json
  pdfUrl      String?
  isPro       Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

model Negotiation {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserNegotiations", fields: [userId], references: [id], onDelete: Cascade)
  input     Json
  result    Json
  pdfUrl    String?
  createdAt DateTime @default(now())

  @@index([userId])
}

model ProfileSnapshot {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserProfileSnapshots", fields: [userId], references: [id], onDelete: Cascade)
  headline  String?
  bio       String?
  skills    String
  resumeId  String?
  createdAt DateTime @default(now())

  @@index([userId])
}

// ============================================================================
//  CONSENT LOGGING
// ============================================================================

model UserConsent {
  id          Int      @id @default(autoincrement())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  consentType String // e.g. "cookies_analytics", "marketing_emails"
  region      String? // e.g. "EU", "US-CA", "BR"
  given       Boolean  @default(true)
  timestamp   DateTime @default(now())

  @@index([userId])
  @@index([userId, consentType])
  @@map("user_consents")
}

// ============================================================================
//  COACHING RELATIONSHIPS
// ============================================================================

model CoachingClient {
  id          String    @id @default(cuid())
  coachId     String
  clientId    String
  status      String    @default("Active") // "Active" | "At Risk" | "New Intake"
  nextSession DateTime?
  lastContact DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  coach  User @relation("CoachClientsCoach", fields: [coachId], references: [id], onDelete: Cascade)
  client User @relation("CoachClientsClient", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([coachId])
  @@index([clientId])
  @@map("coaching_clients")
}

// ============================================================================
//  CONTACTS / NETWORK
// ============================================================================

model Contact {
  id            String   @id @default(cuid())
  userId        String
  contactUserId String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, contactUserId])
  @@index([userId])
  @@index([contactUserId])
  @@map("contacts")
}

model ContactRequest {
  id         String               @id @default(cuid())
  fromUserId String
  toUserId   String
  status     ContactRequestStatus @default(PENDING)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  @@unique([fromUserId, toUserId])
  @@index([fromUserId])
  @@index([toUserId])
  @@map("contact_requests")
}

// ============================================================================
//  USER â€” FULL ACCOUNT + PROFILE
// ============================================================================

model User {
  // â”€â”€ Identity & Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  id                         String    @id @default(cuid())
  email                      String    @unique
  emailVerified              Boolean   @default(false)
  emailVerificationToken     String?   @unique
  emailVerificationExpiresAt DateTime?
  passwordHash               String?
  firstName                  String?
  lastName                   String?
  name                       String?
  image                      String?

  // â”€â”€ Public Profile Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  headline  String?
  pronouns  String?
  location  String?
  status    String?
  avatarUrl String?
  coverUrl  String?

  // Banner / Display
  bannerMode      String? // "cover" | "fit"
  bannerHeight    Int? // 80â€“220
  bannerFocalY    Int? // 0â€“100
  isProfilePublic Boolean @default(false)
  wallpaperUrl    String?

  // â”€â”€ Public URL / Slug â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  slug              String?   @unique
  slugChangeCount   Int       @default(0)
  slugLastChangedAt DateTime?

  // â”€â”€ Main Profile Sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  aboutMe         String?
  workPreferences Json? // { workType, locations[], startDate, relocate, workStatus }
  skillsJson      Json? // ["Leadership", "Azure", "React"]
  languagesJson   Json? // [{ name: "English", level: "Native" }]
  hobbiesJson     Json? // ["Hiking", "Mentorship"]

  // â”€â”€ Account Role & Plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  role                 UserRole @default(SEEKER)
  plan                 Tier     @default(FREE)
  newsletter           Boolean  @default(false)
  mfaEnabled           Boolean  @default(false)
  mfaSecret            String?
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique

  // which account / org this user belongs to (for recruiter tenants)
  accountKey String? // e.g. "ACCT-12345"

  // â”€â”€ Relations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  applications Application[]
  views        JobView[]
  interviews   Interview[]
  offers       Offer[]
  pinnedJobs   PinnedJob[]
  resumes      Resume[]
  covers       Cover[]
  jobs         Job[]
  scanLogs     ScanLog[]

  careerRoadmaps   CareerRoadmap[]   @relation("UserCareerRoadmaps")
  negotiations     Negotiation[]     @relation("UserNegotiations")
  profileSnapshots ProfileSnapshot[] @relation("UserProfileSnapshots")
  consents         UserConsent[]

  candidates           Candidate[]
  candidateAutomations RecruiterCandidateAutomation[]

  // Messaging relations
  messages                 Message[]                 @relation("UserMessages")
  conversationParticipants ConversationParticipant[] @relation("UserConversationParticipants")
  blocksInitiated          UserBlock[]               @relation("UserBlocksAsBlocker")
  blocksReceived           UserBlock[]               @relation("UserBlocksAsBlocked")
  messageReactions         MessageReaction[]         @relation("UserMessageReactions")
  reportsFiled             ConversationReport[]      @relation("UserReportsAsReporter")
  reportsReceived          ConversationReport[]      @relation("UserReportsAsReported")

  // Coaching relations
  coachingClientsAsCoach  CoachingClient[] @relation("CoachClientsCoach")
  coachingClientsAsClient CoachingClient[] @relation("CoachClientsClient")

  // Social / community relations
  groupMemberships        GroupMembership[]
  ownedGroups             Group[]
  ownedPages              Page[]
  pageFollows             PageFollower[]
  ownedNewsletters        Newsletter[]
  newsletterSubscriptions NewsletterSubscription[]

  // â”€â”€ Corporate appearance overrides (ForgeTomorrow staff only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  corporateBannerKey    String? // e.g. "CEO", "CFO", "STAFF_GENERAL"
  corporateBannerLocked Boolean @default(false)

  // â”€â”€ Deletion & Timestamps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("users")
}

// ============================================================================
//  CANDIDATES â€” RECRUITER-FACING SNAPSHOT
// ============================================================================

model Candidate {
  id     Int    @id @default(autoincrement())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic identity & display (powers the card)
  name         String
  email        String?
  headline     String?
  summary      String?
  location     String?
  role         String? // primary role / label used in search
  title        String? // card display title (may mirror role)
  currentTitle String? // explicit current job title, if needed

  // Work preferences / status (powers filters)
  workStatus        String? // employed, actively looking, student, etc.
  preferredWorkType String? // full-time, contract, remote-only, etc.
  willingToRelocate String? // "yes" | "no" | "maybe"

  // Searchable skills / languages (denormalized text)
  skills    String? // comma- or pipe-delimited skills
  languages String? // comma- or pipe-delimited languages

  // Recruiter-only fields (private)
  tags          String? // comma-separated recruiter tags
  notes         String? // private recruiter notes
  source        String? // e.g. "Forge", "Import", "Referral"
  pipelineStage String? // e.g. "new", "reviewing", "contacted"

  // Match data (used by card + WHY)
  match Int? // last known match score (0â€“100)

  lastContacted DateTime?
  lastSeen      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("candidates")
}

// ============================================================================
//  RECRUITER CANDIDATE AUTOMATION
// ============================================================================

model RecruiterCandidateAutomation {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional label, e.g. "Senior CSM â€“ US remote"
  name String?

  // JSON object containing only allowed filters:
  // {
  //   summaryKeywords:   string | null,
  //   jobTitle:          string | null,
  //   workStatus:        string | null,
  //   preferredWorkType: string | null,
  //   relocate:          string | null,
  //   skills:            string | null,
  //   languages:         string | null
  // }
  filters Json

  enabled   Boolean   @default(true)
  lastRunAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("recruiter_candidate_automation")
}

// ============================================================================
//  MESSAGING â€” CONVERSATIONS, MESSAGES, BLOCKS, REACTIONS, REPORTS
// ============================================================================

model Conversation {
  id      Int     @id @default(autoincrement())
  isGroup Boolean @default(false) // false = 1:1, true = group chat
  title   String? // for groups; null for 1:1

  // Which "inbox"/workspace this conversation belongs to:
  // "seeker" | "recruiter" | "coach" | "shared" | null
  channel String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages     Message[]
  participants ConversationParticipant[]
  reports      ConversationReport[]

  @@index([channel])
  @@index([createdAt])
  @@map("conversations")
}

model ConversationParticipant {
  id             Int      @id @default(autoincrement())
  conversationId Int
  userId         String
  joinedAt       DateTime @default(now())
  role           String? // e.g. "owner", "member"

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation("UserConversationParticipants", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id             Int      @id @default(autoincrement())
  conversationId Int
  senderId       String
  content        String
  createdAt      DateTime @default(now())

  conversation Conversation         @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User                 @relation("UserMessages", fields: [senderId], references: [id])
  reactions    MessageReaction[]
  reports      ConversationReport[]

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model UserBlock {
  id        Int      @id @default(autoincrement())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())

  blocker User @relation("UserBlocksAsBlocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("UserBlocksAsBlocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("user_blocks")
}

model MessageReaction {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    String
  emoji     String // raw emoji character
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation("UserMessageReactions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([userId])
  @@map("message_reactions")
}

model ConversationReport {
  id             Int      @id @default(autoincrement())
  conversationId Int
  reporterId     String
  reportedUserId String?
  messageId      Int?
  reason         String // short code or label
  details        String? // optional free-text
  status         String   @default("OPEN") // OPEN, REVIEWING, RESOLVED, DISMISSED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  reporter     User         @relation("UserReportsAsReporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser User?        @relation("UserReportsAsReported", fields: [reportedUserId], references: [id], onDelete: Cascade)
  message      Message?     @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([conversationId])
  @@index([reporterId])
  @@index([reportedUserId])
  @@index([messageId])
  @@map("conversation_reports")
}

// ============================================================================
//  SOCIAL OBJECTS â€” GROUPS, PAGES, NEWSLETTERS
// ============================================================================

model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner       User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  memberships GroupMembership[]

  @@index([ownerId])
  @@map("groups")
}

model GroupMembership {
  id       String   @id @default(cuid())
  groupId  String
  userId   String
  role     String? // "owner" | "moderator" | "member"
  joinedAt DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([userId])
  @@map("group_memberships")
}

model Page {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  website     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner     User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  followers PageFollower[]

  @@index([ownerId])
  @@map("pages")
}

model PageFollower {
  id         String   @id @default(cuid())
  pageId     String
  userId     String
  followedAt DateTime @default(now())

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pageId, userId])
  @@index([userId])
  @@map("page_followers")
}

model Newsletter {
  id          String   @id @default(cuid())
  title       String
  description String?
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner         User                     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  subscriptions NewsletterSubscription[]

  @@index([ownerId])
  @@map("newsletters")
}

model NewsletterSubscription {
  id             String    @id @default(cuid())
  newsletterId   String
  userId         String
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?

  newsletter Newsletter @relation(fields: [newsletterId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([newsletterId, userId])
  @@index([userId])
  @@map("newsletter_subscriptions")
}

// ============================================================================
//  COMMUNITY FEED
// ============================================================================

model FeedPost {
  id         Int      @id @default(autoincrement())
  authorId   String
  authorName String
  content    String
  type       String   @default("business") // "business" | "personal"
  likes      Int      @default(0)
  comments   Json     @default("[]") // [{ by, text, at }]
  reactions  Json     @default("[]") // [{ emoji, userIds, count }]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([authorId])
  @@map("feed_posts")
}

// ============================================================================
//  SUPPORT TICKETS
// ============================================================================

model SupportTicket {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String? // the logged-in user's ID (if available)
  userEmail String? // fallback for anonymous / external support

  subject        String
  initialMessage String

  source    String // e.g. "support-chat", "email"
  personaId String? // daniel, barbara, etc.
  intent    String? // technical, billing, recruiter, emotional, general

  status String // OPEN, IN_PROGRESS, AWAITING_USER, RESOLVED, CLOSED
}

// ============================================================================
//  PROFILE VIEWS â€” WHO'S LOOKING AT YOU
// ============================================================================

model ProfileView {
  id        String   @id @default(cuid())
  viewerId  String? // null if anonymous or not logged in
  targetId  String // the user whose profile was viewed
  source    String? // e.g. "profile", "job-detail", etc.
  createdAt DateTime @default(now())

  @@index([targetId])
  @@index([viewerId])
  @@map("profile_views")
}
